name: Kong Konnect Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of Kong tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - auth
          - rate-limit
          - health
          - load
      endpoint_override:
        description: 'Override Kong endpoint (optional)'
        required: false
        type: string

env:
  KONG_ENDPOINT: ${{ github.event.inputs.endpoint_override || secrets.KONG_ENDPOINT || 'http://kong-4994957fd2euqcpzn.kongcloud.dev' }}

jobs:
  kong-health-test:
    name: Kong Health Check
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'health' || github.event.inputs.test_type == null
    
    steps:
    - name: Test Kong health endpoint
      run: |
        echo "Testing Kong health endpoint: ${{ env.KONG_ENDPOINT }}/healthz"
        
        # Test health endpoint (should work without auth)
        response=$(curl -s -o /tmp/health_response.json -w "%{http_code}" "${{ env.KONG_ENDPOINT }}/healthz")
        
        if [ "$response" -eq 200 ]; then
          echo "✅ Health check passed (HTTP $response)"
          echo "Response:"
          cat /tmp/health_response.json | jq . 2>/dev/null || cat /tmp/health_response.json
        else
          echo "❌ Health check failed (HTTP $response)"
          echo "Response:"
          cat /tmp/health_response.json
          exit 1
        fi

    - name: Test root endpoint
      run: |
        echo "Testing Kong root endpoint: ${{ env.KONG_ENDPOINT }}/"
        
        response=$(curl -s -o /tmp/root_response.json -w "%{http_code}" "${{ env.KONG_ENDPOINT }}/")
        
        if [ "$response" -eq 200 ]; then
          echo "✅ Root endpoint accessible (HTTP $response)"
          echo "Response:"
          cat /tmp/root_response.json | head -20
        else
          echo "⚠️  Root endpoint returned HTTP $response (this might be expected)"
          cat /tmp/root_response.json
        fi

  kong-auth-test:
    name: Kong Authentication Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'auth' || github.event.inputs.test_type == null
    
    steps:
    - name: Test protected endpoint without API key (should fail)
      run: |
        echo "Testing protected endpoint without API key (should fail)"
        echo "Endpoint: ${{ env.KONG_ENDPOINT }}/api/v1/sum"
        
        response=$(curl -s -o /tmp/no_auth_response.json -w "%{http_code}" \
          -X POST "${{ env.KONG_ENDPOINT }}/api/v1/sum" \
          -H "Content-Type: application/json" \
          -d '{"numbers": [1, 2, 3, 4, 5]}')
        
        echo "Response code: $response"
        echo "Response body:"
        cat /tmp/no_auth_response.json
        
        # Should return 401 (Unauthorized) or 403 (Forbidden)
        if [ "$response" -eq 401 ] || [ "$response" -eq 403 ]; then
          echo "✅ Authentication properly blocks unauthorized requests (HTTP $response)"
        else
          echo "❌ Expected 401 or 403, got $response"
          echo "Authentication might not be properly configured"
          exit 1
        fi

    - name: Test protected endpoint with valid API key
      run: |
        echo "Testing protected endpoint with valid API key"
        echo "Using API key from secrets: ${{ secrets.KONG_API_KEY }}"
        
        if [ -z "${{ secrets.KONG_API_KEY }}" ]; then
          echo "❌ KONG_API_KEY secret is not set"
          echo "Please add the secret: test-user-bob:BOB-API-KEY-123"
          exit 1
        fi
        
        response=$(curl -s -o /tmp/auth_response.json -w "%{http_code}" \
          -X POST "${{ env.KONG_ENDPOINT }}/api/v1/sum" \
          -H "Content-Type: application/json" \
          -H "${{ secrets.KONG_API_KEY }}" \
          -d '{"numbers": [1, 2, 3, 4, 5]}')
        
        echo "Response code: $response"
        echo "Response body:"
        cat /tmp/auth_response.json | jq . 2>/dev/null || cat /tmp/auth_response.json
        
        if [ "$response" -eq 200 ]; then
          echo "✅ Authentication with API key successful (HTTP $response)"
          
          # Verify the response contains expected sum
          if cat /tmp/auth_response.json | grep -q '"sum".*15'; then
            echo "✅ API response contains correct sum (15)"
          else
            echo "⚠️  API response might not contain expected sum"
          fi
        else
          echo "❌ Expected 200, got $response"
          echo "Check if API key is correct or Kong configuration"
          exit 1
        fi

  kong-rate-limit-test:
    name: Kong Rate Limiting Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'rate-limit' || github.event.inputs.test_type == null
    
    steps:
    - name: Test rate limiting
      run: |
        echo "Testing Kong rate limiting with multiple requests"
        echo "Making 11 requests to trigger rate limit"
        
        if [ -z "${{ secrets.KONG_API_KEY }}" ]; then
          echo "❌ KONG_API_KEY secret is not set"
          exit 1
        fi
        
        success_count=0
        rate_limited_count=0
        other_errors=0
        
        # Make 11 requests as specified in your example
        for i in {1..11}; do
          echo "Request $i/11..."
          
          response=$(curl -s -o /tmp/rate_limit_response_$i.json -w "%{http_code}" \
            -X POST "${{ env.KONG_ENDPOINT }}/api/v1/sum" \
            -H "Content-Type: application/json" \
            -H "${{ secrets.KONG_API_KEY }}" \
            -d '{"numbers": [1, 2, 3, 4, 5]}')
          
          echo "  Response: HTTP $response"
          
          case $response in
            200)
              success_count=$((success_count + 1))
              echo "  ✅ Request successful"
              ;;
            429)
              rate_limited_count=$((rate_limited_count + 1))
              echo "  🚫 Rate limited (expected after several requests)"
              cat /tmp/rate_limit_response_$i.json | head -2
              ;;
            *)
              other_errors=$((other_errors + 1))
              echo "  ❌ Unexpected response: $response"
              cat /tmp/rate_limit_response_$i.json | head -2
              ;;
          esac
          
          # Small delay between requests
          sleep 0.5
        done
        
        echo ""
        echo "=== Rate Limiting Test Results ==="
        echo "Successful requests: $success_count"
        echo "Rate limited requests: $rate_limited_count"
        echo "Other errors: $other_errors"
        
        # Validate results
        if [ $success_count -gt 0 ] && [ $rate_limited_count -gt 0 ]; then
          echo "✅ Rate limiting is working correctly!"
          echo "   - Some requests succeeded ($success_count)"
          echo "   - Some requests were rate limited ($rate_limited_count)"
        elif [ $success_count -gt 0 ] && [ $rate_limited_count -eq 0 ]; then
          echo "⚠️  Rate limiting might not be configured"
          echo "   - All $success_count requests succeeded"
          echo "   - No rate limiting detected"
        elif [ $success_count -eq 0 ]; then
          echo "❌ No requests succeeded - check API key or Kong configuration"
          exit 1
        fi

  kong-load-test:
    name: Kong Load Testing
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'load' || github.event.inputs.test_type == null
    
    steps:
    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: Create k6 load test script
      run: |
        cat > kong-load-test.js << 'EOF'
        import http from 'k6/http';
        import { check, sleep } from 'k6';

        export const options = {
          stages: [
            { duration: '30s', target: 10 },  // Ramp up
            { duration: '1m', target: 20 },   // Stay at 20 users
            { duration: '30s', target: 0 },   // Ramp down
          ],
          thresholds: {
            http_req_duration: ['p(95)<500'], // 95% of requests under 500ms
            http_req_failed: ['rate<0.1'],    // Error rate under 10%
          },
        };

        const KONG_ENDPOINT = '${{ env.KONG_ENDPOINT }}';
        const API_KEY = '${{ secrets.KONG_API_KEY }}';

        export default function () {
          // Test health endpoint (no auth)
          let healthRes = http.get(`${KONG_ENDPOINT}/healthz`);
          check(healthRes, {
            'health check status is 200': (r) => r.status === 200,
            'health check response time < 200ms': (r) => r.timings.duration < 200,
          });

          // Test API endpoint with auth
          if (API_KEY) {
            let apiRes = http.post(
              `${KONG_ENDPOINT}/api/v1/sum`,
              JSON.stringify({ numbers: [1, 2, 3, 4, 5] }),
              {
                headers: {
                  'Content-Type': 'application/json',
                  [API_KEY.split(':')[0]]: API_KEY.split(':')[1],
                },
              }
            );
            
            check(apiRes, {
              'API status is 200': (r) => r.status === 200,
              'API response time < 300ms': (r) => r.timings.duration < 300,
              'API returns correct sum': (r) => {
                try {
                  const body = JSON.parse(r.body);
                  return body.sum === 15;
                } catch (e) {
                  return false;
                }
              },
            });
          }

          sleep(1);
        }
        EOF

    - name: Run k6 load test
      run: |
        echo "🚀 Running k6 load test against Kong Konnect endpoint"
        echo "Endpoint: ${{ env.KONG_ENDPOINT }}"
        echo "API Key: ${{ secrets.KONG_API_KEY && 'Configured' || 'Not configured' }}"
        
        if [ -z "${{ secrets.KONG_API_KEY }}" ]; then
          echo "⚠️  API key not configured, testing health endpoint only"
        fi
        
        # Run k6 and capture both console output and JSON results
        k6 run --summary-trend-stats="avg,min,med,max,p(95),p(99),count" \
          --out json=k6-results.json \
          kong-load-test.js | tee k6-output.txt
        
        echo "📊 K6 Load Test Results:" > k6-summary.txt
        echo "========================" >> k6-summary.txt
        
        # Extract key metrics from k6 output
        if [ -f k6-output.txt ]; then
          echo "" >> k6-summary.txt
          echo "**Test Summary:**" >> k6-summary.txt
          grep -E "(scenarios|checks|data_received|data_sent|http_req_duration|http_req_failed|http_reqs|vus)" k6-output.txt >> k6-summary.txt 2>/dev/null || echo "Metrics extraction failed" >> k6-summary.txt
          
          echo "" >> k6-summary.txt
          echo "**Performance Metrics:**" >> k6-summary.txt
          grep -E "(avg=|min=|med=|max=|p\(95\)=|p\(99\)=)" k6-output.txt >> k6-summary.txt 2>/dev/null || echo "Performance metrics not found" >> k6-summary.txt
        fi
        
        echo "" >> k6-summary.txt
        echo "**Load Test Configuration:**" >> k6-summary.txt
        echo "- Ramp up: 10 users over 30s" >> k6-summary.txt
        echo "- Sustained: 20 users for 1 minute" >> k6-summary.txt
        echo "- Ramp down: to 0 users over 30s" >> k6-summary.txt
        echo "- Total duration: ~2 minutes" >> k6-summary.txt

    - name: Upload k6 results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: k6-load-test-results
        path: |
          k6-results.json
          k6-output.txt
          k6-summary.txt
        retention-days: 7

  kong-comprehensive-test:
    name: Kong Comprehensive Test
    runs-on: ubuntu-latest
    needs: [kong-health-test, kong-auth-test, kong-rate-limit-test, kong-load-test]
    if: always() && (github.event.inputs.test_type == 'all' || github.event.inputs.test_type == null)
    
    steps:
    - name: Test summary
      run: |
        echo "## Kong Konnect Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Endpoint:** ${{ env.KONG_ENDPOINT }}" >> $GITHUB_STEP_SUMMARY
        echo "**API Key:** ${{ secrets.KONG_API_KEY && 'Configured' || 'Missing' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.kong-health-test.result }}" == "success" ]; then
          echo "✅ **Health Check:** PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Health Check:** FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.kong-auth-test.result }}" == "success" ]; then
          echo "✅ **Authentication:** PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Authentication:** FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.kong-rate-limit-test.result }}" == "success" ]; then
          echo "✅ **Rate Limiting:** PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Rate Limiting:** FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.kong-load-test.result }}" == "success" ]; then
          echo "✅ **Load Testing:** PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Load Testing:** FAILED" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Download k6 results
      uses: actions/download-artifact@v3
      if: needs.kong-load-test.result == 'success'
      with:
        name: k6-load-test-results
        path: ./k6-results/

    - name: Add k6 results to summary
      if: needs.kong-load-test.result == 'success'
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📊 Load Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "./k6-results/k6-summary.txt" ]; then
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat "./k6-results/k6-summary.txt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ K6 results not available" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**📈 Key Performance Indicators:**" >> $GITHUB_STEP_SUMMARY
        
        # Extract specific metrics if available
        if [ -f "./k6-results/k6-output.txt" ]; then
          # Extract response time percentiles
          P95=$(grep -o "p(95)=[0-9.]*ms" "./k6-results/k6-output.txt" | head -1 | cut -d'=' -f2 || echo "N/A")
          P99=$(grep -o "p(99)=[0-9.]*ms" "./k6-results/k6-output.txt" | head -1 | cut -d'=' -f2 || echo "N/A")
          AVG=$(grep -o "avg=[0-9.]*ms" "./k6-results/k6-output.txt" | head -1 | cut -d'=' -f2 || echo "N/A")
          
          # Extract success rate
          SUCCESS_RATE=$(grep -o "http_req_failed.*[0-9.]*%" "./k6-results/k6-output.txt" | grep -o "[0-9.]*%" | head -1 || echo "N/A")
          TOTAL_REQUESTS=$(grep -o "http_reqs.*[0-9]*" "./k6-results/k6-output.txt" | grep -o "[0-9]*" | head -1 || echo "N/A")
          
          echo "- **Average Response Time:** $AVG" >> $GITHUB_STEP_SUMMARY
          echo "- **95th Percentile:** $P95" >> $GITHUB_STEP_SUMMARY  
          echo "- **99th Percentile:** $P99" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Requests:** $TOTAL_REQUESTS" >> $GITHUB_STEP_SUMMARY
          echo "- **Error Rate:** $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Finalize summary
      run: |
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Quick Test Commands" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Health check" >> $GITHUB_STEP_SUMMARY
        echo 'curl ${{ env.KONG_ENDPOINT }}/healthz' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Protected endpoint with auth" >> $GITHUB_STEP_SUMMARY
        echo 'curl -H "test-user-bob:BOB-API-KEY-123" \' >> $GITHUB_STEP_SUMMARY
        echo '  -X POST ${{ env.KONG_ENDPOINT }}/api/v1/sum \' >> $GITHUB_STEP_SUMMARY
        echo '  -H "Content-Type: application/json" \' >> $GITHUB_STEP_SUMMARY
        echo '  -d '"'"'{"numbers": [1, 2, 3, 4, 5]}'"'"'' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Rate limit test" >> $GITHUB_STEP_SUMMARY
        echo 'for i in {1..11}; do' >> $GITHUB_STEP_SUMMARY
        echo '  curl -H "test-user-bob:BOB-API-KEY-123" \' >> $GITHUB_STEP_SUMMARY
        echo '    -X POST ${{ env.KONG_ENDPOINT }}/api/v1/sum \' >> $GITHUB_STEP_SUMMARY
        echo '    -H "Content-Type: application/json" \' >> $GITHUB_STEP_SUMMARY
        echo '    -d '"'"'{"numbers": [1, 2, 3, 4, 5]}'"'"'' >> $GITHUB_STEP_SUMMARY
        echo 'done' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Load test with k6" >> $GITHUB_STEP_SUMMARY
        echo 'k6 run --vus 10 --duration 30s <(cat << '"'"'EOF'"'"'' >> $GITHUB_STEP_SUMMARY
        echo 'import http from '"'"'k6/http'"'"';"' >> $GITHUB_STEP_SUMMARY
        echo 'export default function() {' >> $GITHUB_STEP_SUMMARY
        echo '  http.get('"'"'${{ env.KONG_ENDPOINT }}/healthz'"'"');' >> $GITHUB_STEP_SUMMARY
        echo '}' >> $GITHUB_STEP_SUMMARY
        echo 'EOF' >> $GITHUB_STEP_SUMMARY
        echo ')' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
